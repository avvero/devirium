Было ли у вас такое, что в вашем проекте есть интеграционные тесты и они выполняются долго. Unit тесты при этом выполнились бы быстрее. Может ли мы только на основе этого говорить о том, что интеграционные тесты нужно менять на unit? Давайте разберемся. 

Время выполнения теста - это всего лишь синтетическая метрика, которой недостаточно для принятия обоснованного  решения о приоритете различных видов тестирования. Наша главная цель (я надеюсь) - не просто «прогнать тесты и сделать это быстро», а гарантировать соответствие поведения требованиям (как функциональным, так и нефункциональным).

Не затрагиваются прочие критерии оценки тестов. Речь о том, чтобы указать на тот факт, что оценивать тесты только по времени выполнения не достаточно.

Для начала давайте дадим определение видам тестов.

Время выполнения теста должно быть пропорционально тбьекту, не sut, а бьекту - то что мы тестируем, меток, фича

## Дисклеймер

Мой личный опыт связан с разработкой сервисов в рамках продуктовой разработки. В данной статье я говорю именно о такой разработке, а не о создании библиотек, фреймворков, баз данных и других замечательных вещей. Также я не касаюсь проектной разработки, где код пишется на заказ и передаётся в поддержку другим.

Я хочу отдельно указать на то, что лично я понимаю под тем или иным типом тестов. Чтобы синхронизироваться с читателем. Так же я приведу источники, на основе которых я сделал подобные выводы.

## Определение

Юнит-тестом называется тест, который, проверяет одну единицу поведения, делает это быстро и в изоляции от других тестов. Любой тест, не удовлетворяющий хотя бы одному из этих трёх критериев, относится к категории интеграционных. Термин юнит в юнит-тестах относится к единице поведения, а не кода. Объем кода, необходимый для такой единицы, не имеет значения.

Интеграционный тест - тест, который проверяет взаимодействие нескольких компонентов системы, чтобы убедиться, что они корректно интегрированы и выполняют ожидаемое поведение.

Контрактные интеграционные тесты - это методика тестирования, при которой приложение проверяется в изоляции для подтверждения, что сообщения, которые оно отправляет или получает, соответствуют общему пониманию, задокументированному в "контракте". Этот подход позволяет убедиться, что взаимодействие между различными частями системы происходит в соответствии с ожиданиями.

Внепроцессные зависимости в контексте тестирования:
- Управляемые зависимости - внепроцессные зависимости, находящиеся под полным контролем. Пример: база данных,  кеш. 
- Неуправляемые зависимости - внепроцессные зависимости, которые не находятся под полным контролем. Пример: шина данных, api-gate, внешние сервисы - nbs, vps по отношению к compute.

Контрактные интеграционные тесты тесты проверяют взаимодействие между компонентами приложения через публичный API, часто используя моки для имитации неуправляемых внепроцессных зависимостей.

Компонентные тесты - тесты, которые проверяют поведение одного компонента приложения, используя реальные неуправляемые внепроцессные зависимости.

E2E-тесты (end-to-end tests) - проверка методом чёрного ящика бизнес сценариев работы приложения с точки зрения конечного пользователя на реальном стенде (preprod, prod).

Источники:

https://martinfowler.com/bliki/UnitTest.html
https://martinfowler.com/bliki/IntegrationTest.html
Принципы юнит-тестирования, Владимир Хориков
https://medium.com/%40wilsonsinquest/on-writing-tests-as-an-induction-proof-of-system-correctness-5ddae19207ca
https://martinfowler.com/articles/nonDeterminism.html

## Время получения обратной связи от теста

Предлагаю рассмотреть две ключевые характеристики:
- Время получения обратной связи от теста
- Качество обратной связи

Время выполнения теста и время получения обратной связи - это разные вещи. Допустим, у нас есть E2E-тесты, которые запускаются на выделенном контуре. Чтобы проверить свежий код, необходимо:
1. Закоммитить изменения
2. Дождаться прохождения quality gates в ci
3. Провести ревью (если оно требуется перед выкатыванием на стенд)
4. Выкатить изменения на стенд
5. Запустить тесты

Возможно в вашем случае список действий будет меньше или больше, но в целом картина такая.

Таким образом, время от момента готовности кода до получения результатов тестов - это и есть время получения обратной связи. Если сами E2E-тесты выполняются, например, за час, то фактическое время получения обратной связи от таких тестов может исчисляться часами или даже днями.

Unit-тесты. Юнит-тесты проверяют небольшие участки кода в изоляции. Они дают практически мгновенный фидбэк – выполняются за миллисекунды​, что обеспечивает очень высокую скорость обратной связи. Однако охват у них самый узкий: unit-тест гарантирует корректность отдельного юнита (функций и классов), но не выявляет проблем во взаимодействии компонентов. Качество обратной связи от таких тестов относительно невысокое в том смысле, что зелёные юнит-тесты еще не гарантируют работоспособность системы на уровне бизнес-сценариев. 

Интеграционные тесты. Интеграционные тесты проверяют совместную работу нескольких модулей или сервисов. Они работают медленнее юнит-тестов (секунды)​, поэтому фидбэк приходит не так быстро. Зато эти тесты покрывают взаимодействия компонентов, повышая уверенность в том, что части системы правильно работают вместе. По качеству обратной связи интеграционные тесты занимают промежуточное положение: они выявляют дефекты на стыках модулей (что не видно юнит-тестам), хотя всё еще не охватывают систему целиком. При падении интеграционного теста приходится немного потрудиться, чтобы найти, в каком компоненте сбой, но обычно локализовать проблему проще, чем с E2E​.

Глубокие Интеграционные тесты.

Компонентные тесты. Компонентное тестирование можно рассматривать как проверку более крупного блока системы в относительно изолированной среде (например, тестирование отдельного сервиса целиком с его зависимостями, или UI-компонента со всеми подкомпонентами). По скорости такие тесты уступают юнит-тестам, так как затрагивают больше кода и могут требовать поднятия дополнительных частей системы (базы данных, оболочки приложения и т.д.). Однако компонентные тесты обычно быстрее полноценных сквозных E2E, поскольку сфокусированы на одном компоненте и могут выполнять часть действий в контролируемой среде. Качество обратной связи от компонентных тестов выше, чем у низкоуровневых тестов: они дают уверенность, что отдельный компонент (подсистема) в целом выполняет требуемые функции. Тем не менее, они не заменяют E2E, так как не охватывают взаимодействие данного компонента с остальной системой.

E2E-тесты. End-to-end тесты имитируют работу системы глазами пользователя, проверяя полный пользовательский сценарий от начала до конца. Такие тесты дают наибольшую ценность и качество обратной связи – высокий уровень уверенности, что вся система соответствует ожиданиям конечного пользователя​. Иными словами, если E2E-тесты проходят, значит основные бизнес-функции работают корректно в реальных условиях. Однако расплата за это – низкая скорость фидбэка. E2E-тесты самые медленные: один сценарий может выполняться десятки секунд или минуты​, а полный прогон большого набора E2E способен занять часы. Это значительно замедляет цикл обратной связи разработчика с системой. Кроме того, в случае падения E2E-теста известен лишь факт сбоя в сценарии, но не очевидна причина на уровне кода – приходится тратить время на поиски, в каком сервисе или модуле произошла ошибка​. Таким образом, сквозные тесты обеспечивают самую полную проверку (высокое качество обратной связи), но при самой медленной отдаче результата.

Вывод: быстрые низкоуровневые тесты (юнит) дают мгновенную обратную связь, но проверяют ограниченный контекст, тогда как медленные сквозные тесты охватывают систему целиком, давая более ценную информацию о её работе​. Интеграционные и компонентные тесты занимают промежуточный баланс между этими крайностями. На графике это отражено положением точек: юнит-тесты – в правом нижнем углу (максимальная скорость, минимальный охват), E2E – в левом верхнем (низкая скорость, максимальный охват), а интеграционное и компонентное тестирование располагаются между ними по диагонали. Такая диаграмма подчёркивает необходимость комбинировать разные уровни тестов, чтобы команда получала и быструю обратную связь при изменениях, и уверенность в качестве продукта на высоком уровне. Например, Google рекомендует стратегию тестирования с преобладанием быстрых юнит-тестов, дополняемых некоторым количеством интеграционных и небольшим числом E2E-тестов​ – это позволяет добиться разумного баланса между скоростью и качеством обратной связи.



При сравнении unit-тестов, интеграционных, компонентных и E2E-тестов наблюдается обратная зависимость: чем быстрее тест даёт обратную связь, тем менее точную и полную информацию о работоспособности системы он предоставляет - и наоборот.

Контрактные интеграционные тесты представляют собой компромиссное решение: они обеспечивают качество обратной связи, приближенное к E2E, но при этом их выполнение занимает время, сопоставимое с unit-тестами.

При этом интеграционные тесты не «цементируют» код так, как это делают unit-тесты. Они позволяют сохранять гибкость (evolvability) - способность кода изменяться с минимальными затратами на сопровождение. Это особенно важно для сервисов на ранних этапах их развития.

Такой подход отражён во многих книгах, включая Angry Tests Е. Бугаенко и Принципы юнит-тестирования В. Хорикова.

##

Важно не время выполнения теста, а время получения обратной связи от теста о работоспособности системы. Т.е. есть код и нужно проверить выполняет ли он требуемый контракт. Время выполнения тесты и время получения обратной связи это разные вещи. Давайте представим, что у нас есть e2e тесты и они запускаются на специально выделенном контуре. Чтобы проверить свежий код, нужно его закомитить, подождать прохождения quality gates, возможность review, если оно требуется для выката на стенд. Выкатить на стенд. Запустить тесты. Вот все это время от готовности кода к проверки и фактического запуска теста против этого кода и есть время получения обратной связи. Если для unit тестов это одна и та же величина, то для e2e это разные величины. При этом для e2e это время может измерятся часами, а то и больше. В то время как для unit тестов это миллисекунды. 

Интеграционные контрактные тесты по качеству обратной связи ближе к e2e теста, но по скорости ее получения ближе к unit.

## Время выполнения теста

Время выполнения теста это синтетическая характеристика, которая по сути ни о чем не говорит. Предлагаю рассмотреть такие:
- скорость получения обратной связи от теста
- качество обратной связи

Смотри, есть такие типы тестирования:
- unit
- интеграционные тесты (поднимается все приложение, внепроцессные зависимости мокируются c wiremock, проверка через api приложения)
- component testing (поднимается приложение и все его внепроцесные зависимости в docker и тестируется набором тестов похожим на e2e, но облегченным)
- e2e тесты

## Баланс между скоростью и качеством обратной связи у разных видов тестов

При сравнении unit-тестов, интеграционных, компонентных и E2E (end-to-end) тестов наблюдается обратная зависимость: чем быстрее тест дает обратную связь, тем менее всеобъемлющую информацию о работоспособности системы он предоставляет, и наоборот​. Ниже приведен график, иллюстрирующий эту зависимость (ось X – скорость получения обратной связи, ось Y – «качество» обратной связи, подразумевающее степень уверенности в корректной работе системы):
```
             ↑ Качество обратной связи (выше лучше)
             | ● E2E-тесты (сквозные)
             |       ● Интеграционные тесты
             |              ● Компонентные тесты
             |                        ● Unit-тесты
             +-----------------------------------------→ Скорость обратной связи (быстрее)
```

Unit-тесты. Юнит-тесты проверяют небольшие участки кода в изоляции. Они дают практически мгновенный фидбэк – выполняются за миллисекунды​, что обеспечивает очень высокую скорость обратной связи. Однако охват у них самый узкий: unit-тест гарантирует корректность отдельного модуля (функции, класса), но не выявляет проблем во взаимодействии компонентов. Качество обратной связи от таких тестов относительно невысокое в том смысле, что зелёные юнит-тесты еще не гарантируют работоспособность системы на уровне бизнес-сценариев. Зато сами по себе они чрезвычайно точечно указывают на место сбоя и легко локализуют дефекты в конкретном модуле.

Интеграционные тесты. Интеграционные тесты проверяют совместную работу нескольких модулей или сервисов. Они работают медленнее юнит-тестов (порядка секунд на тест)​, поэтому фидбэк приходит не так быстро. Зато эти тесты покрывают взаимодействия компонентов, повышая уверенность в том, что части системы правильно работают вместе. По качеству обратной связи интеграционные тесты занимают промежуточное положение: они выявляют дефекты на стыках модулей (что не видно юнит-тестам), хотя всё еще не охватывают систему целиком. При падении интеграционного теста приходится немного потрудиться, чтобы найти, в каком компоненте сбой, но обычно локализовать проблему проще, чем с E2E​.

Глубокие Интеграционные тесты.

Компонентные тесты. Компонентное тестирование можно рассматривать как проверку более крупного блока системы в относительно изолированной среде (например, тестирование отдельного сервиса целиком с его зависимостями, или UI-компонента со всеми подкомпонентами). По скорости такие тесты уступают юнит-тестам, так как затрагивают больше кода и могут требовать поднятия дополнительных частей системы (базы данных, оболочки приложения и т.д.). Однако компонентные тесты обычно быстрее полноценных сквозных E2E, поскольку сфокусированы на одном компоненте и могут выполнять часть действий в контролируемой среде. Качество обратной связи от компонентных тестов выше, чем у низкоуровневых тестов: они дают уверенность, что отдельный компонент (подсистема) в целом выполняет требуемые функции. Тем не менее, они не заменяют E2E, так как не охватывают взаимодействие данного компонента с остальной системой.

E2E-тесты. End-to-end тесты имитируют работу системы глазами пользователя, проверяя полный пользовательский сценарий от начала до конца. Такие тесты дают наибольшую ценность и качество обратной связи – высокий уровень уверенности, что вся система соответствует ожиданиям конечного пользователя​. Иными словами, если E2E-тесты проходят, значит основные бизнес-функции работают корректно в реальных условиях. Однако расплата за это – низкая скорость фидбэка. E2E-тесты самые медленные: один сценарий может выполняться десятки секунд или минуты​, а полный прогон большого набора E2E способен занять часы. Это значительно замедляет цикл обратной связи разработчика с системой. Кроме того, в случае падения E2E-теста известен лишь факт сбоя в сценарии, но не очевидна причина на уровне кода – приходится тратить время на поиски, в каком сервисе или модуле произошла ошибка​. Таким образом, сквозные тесты обеспечивают самую полную проверку (высокое качество обратной связи), но при самой медленной отдаче результата.

Вывод: быстрые низкоуровневые тесты (юнит) дают мгновенную обратную связь, но проверяют ограниченный контекст, тогда как медленные сквозные тесты охватывают систему целиком, давая более ценную информацию о её работе​. Интеграционные и компонентные тесты занимают промежуточный баланс между этими крайностями. На графике это отражено положением точек: юнит-тесты – в правом нижнем углу (максимальная скорость, минимальный охват), E2E – в левом верхнем (низкая скорость, максимальный охват), а интеграционное и компонентное тестирование располагаются между ними по диагонали. Такая диаграмма подчёркивает необходимость комбинировать разные уровни тестов, чтобы команда получала и быструю обратную связь при изменениях, и уверенность в качестве продукта на высоком уровне. Например, Google рекомендует стратегию тестирования с преобладанием быстрых юнит-тестов, дополняемых некоторым количеством интеграционных и небольшим числом E2E-тестов​ – это позволяет добиться разумного баланса между скоростью и качеством обратной связи.

#draft #article